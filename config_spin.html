<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quay Số Ngẫu Nhiên</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            background-image: url('https://www.transparenttextures.com/patterns/digital-circuit.png');
            background-size: cover;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
        }
        .button-group button {
            padding: 10px 20px;
            margin: 0 10px;
            background-color: #ff69b4;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .button-group button:hover {
            background-color: #ff1493;
        }
        .result-section {
            margin-top: 20px;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .back-btn {
            margin-bottom: 20px;
        }
        /* CSS cho hiệu ứng slot machine */
        #stage {
            perspective: 1000px;
            margin: 20px auto;
        }
        .ring {
            position: relative;
            width: 60px;
            height: 80px;
            display: inline-block;
            margin: 0 5px;
            transform-style: preserve-3d;
        }
        .slot {
            position: absolute;
            width: 60px;
            height: 80px;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 5px;
            text-align: center;
            line-height: 80px;
            font-size: 36px;
        }
        .slot p {
            margin: 0;
        }
        .backface-on .slot {
            backface-visibility: hidden;
        }
        #rotate {
            transform-style: preserve-3d;
            transition: transform 2s;
        }
        .tilted {
            transform: rotateX(45deg);
        }
        .perspective-on {
            perspective: 1000px;
        }
        .perspective-off {
            perspective: none;
        }
        /* Keyframes cho hiệu ứng quay */
        @keyframes back-spin {
            0% { transform: rotateX(0deg); }
            100% { transform: rotateX(-360deg); }
        }
        @keyframes spin-0 { 0% { transform: rotateX(0deg); } 100% { transform: rotateX(360deg); } }
        @keyframes spin-1 { 0% { transform: rotateX(0deg); } 100% { transform: rotateX(330deg); } }
        @keyframes spin-2 { 0% { transform: rotateX(0deg); } 100% { transform: rotateX(300deg); } }
        @keyframes spin-3 { 0% { transform: rotateX(0deg); } 100% { transform: rotateX(270deg); } }
        @keyframes spin-4 { 0% { transform: rotateX(0deg); } 100% { transform: rotateX(240deg); } }
        @keyframes spin-5 { 0% { transform: rotateX(0deg); } 100% { transform: rotateX(210deg); } }
        @keyframes spin-6 { 0% { transform: rotateX(0deg); } 100% { transform: rotateX(180deg); } }
        @keyframes spin-7 { 0% { transform: rotateX(0deg); } 100% { transform: rotateX(150deg); } }
        @keyframes spin-8 { 0% { transform: rotateX(0deg); } 100% { transform: rotateX(120deg); } }
        @keyframes spin-9 { 0% { transform: rotateX(0deg); } 100% { transform: rotateX(90deg); } }
        @keyframes spin-10 { 0% { transform: rotateX(0deg); } 100% { transform: rotateX(60deg); } }
        @keyframes spin-11 { 0% { transform: rotateX(0deg); } 100% { transform: rotateX(30deg); } }
        @keyframes tiltin {
            0% { transform: rotateX(0deg); }
            100% { transform: rotateX(45deg); }
        }
        @keyframes tiltout {
            0% { transform: rotateX(45deg); }
            100% { transform: rotateX(0deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="btn btn-secondary back-btn">Quay lại</a>
        <h1>Quay Số Ngẫu Nhiên</h1>
        <div id="stage" class="perspective-on">
            <div id="rotate">
                <div class="ring" id="ring1"></div>
                <div class="ring" id="ring2"></div>
                <div class="ring" id="ring3"></div>
                <div class="ring" id="ring4"></div>
                <div class="ring" id="ring5"></div>
                <div class="ring" id="ring6"></div>
            </div>
        </div>
        <div class="button-group" id="buttonGroup"></div>
        <div class="result-section" id="resultSection" style="display: none;">
            <h3>Kết Quả</h3>
            <p><strong>Tên giải:</strong> <span id="resultPrize"></span></p>
            <p><strong>Lần quay:</strong> <span id="resultTurn"></span></p>
            <p><strong>Họ tên:</strong> <span id="resultName"></span></p>
            <p><strong>Phòng ban:</strong> <span id="resultDepartment"></span></p>
            <p><strong>Mã quay số:</strong> <span id="resultCode"></span></p>
        </div>
        <div class="mt-3">
            <label><input type="checkbox" id="xray"> X-Ray (Hiển thị mặt sau)</label>
            <label><input type="checkbox" id="perspective" checked> Perspective (Hiệu ứng 3D)</label>
        </div>
    </div>

    <!-- Bootstrap JS and Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
    <script>
        // Constants cho slot machine
        const SLOTS_PER_REEL = 12;
        const REEL_RADIUS = 150;

        // Lấy dữ liệu từ localStorage
        let prizes = JSON.parse(localStorage.getItem('prizes')) || [];
        let participants = JSON.parse(localStorage.getItem('participants')) || [];
        let winners = JSON.parse(localStorage.getItem('winners')) || [];

        let currentPrize = null;
        let currentPrizeIndex = -1;

        // Tạo các nút quay số dựa trên danh sách giải
        const buttonGroup = document.getElementById('buttonGroup');
        prizes.forEach((prize, index) => {
            if (prize.status === 'Chưa quay') {
                const button = document.createElement('button');
                button.textContent = prize.name;
                button.onclick = () => {
                    currentPrize = prize;
                    currentPrizeIndex = index;
                    document.querySelector('.go').style.display = 'inline-block';
                };
                buttonGroup.appendChild(button);
            }
        });

        // Thêm nút "Quay" (go)
        const goButton = document.createElement('button');
        goButton.className = 'go';
        goButton.textContent = 'Quay';
        goButton.style.display = 'none';
        buttonGroup.appendChild(goButton);

        // Hàm tạo slots
        function createSlots(ring) {
            var slotAngle = 360 / SLOTS_PER_REEL;

            for (var i = 0; i < SLOTS_PER_REEL; i++) {
                var slot = document.createElement('div');
                slot.className = 'slot';
                var transform = 'rotateX(' + (slotAngle * i) + 'deg) translateZ(' + REEL_RADIUS + 'px)';
                slot.style.transform = transform;

                // Hiển thị số từ 0 đến 9 (thay vì 0-11)
                var content = $(slot).append('<p>' + (i % 10) + '</p>');
                ring.append(slot);
            }
        }

        // Hàm lấy seed (để chọn vị trí dừng của vòng quay)
        function getSeed() {
            return Math.floor(Math.random() * SLOTS_PER_REEL);
        }

        // Hàm quay số
        function spin(timer) {
            if (!currentPrize || currentPrizeIndex === -1) {
                alert('Vui lòng chọn một giải để quay!');
                return;
            }

            if (participants.length === 0) {
                alert('Không có người tham dự để quay số!');
                return;
            }

            // Chọn ngẫu nhiên một người tham dự
            const randomIndex = Math.floor(Math.random() * participants.length);
            const winner = participants[randomIndex];
            const randomCode = winner.code.padStart(6, '0'); // Đảm bảo mã có 6 chữ số

            // Quay từng vòng để dừng lại ở các chữ số của mã trúng thưởng
            for (var i = 1; i <= 6; i++) {
                var oldSeed = -1;
                var oldClass = $('#ring' + i).attr('class');
                if (oldClass.length > 4) {
                    oldSeed = parseInt(oldClass.slice(10));
                }
                // Chọn seed tương ứng với chữ số của mã trúng thưởng
                var targetDigit = parseInt(randomCode[i - 1]); // Chữ số cần dừng
                var seed = targetDigit; // Seed sẽ là vị trí của chữ số (0-9)
                while (oldSeed == seed) {
                    seed = (seed + 1) % SLOTS_PER_REEL;
                }

                $('#ring' + i)
                    .css('animation', 'back-spin 1s, spin-' + seed + ' ' + (timer + i * 0.5) + 's')
                    .attr('class', 'ring spin-' + seed);
            }

            // Sau khi quay xong, cập nhật kết quả
            setTimeout(() => {
                updateResult(currentPrize, currentPrizeIndex, winner, randomCode);
            }, (timer + 3) * 1000); // Chờ animation hoàn tất
        }

        // Cập nhật kết quả sau khi quay
        function updateResult(prize, prizeIndex, winner, randomCode) {
            // Cập nhật trạng thái giải thành "Đã quay"
            prizes[prizeIndex].status = 'Đã quay';
            localStorage.setItem('prizes', JSON.stringify(prizes));

            // Tính lần quay hiện tại cho giải này
            const currentTurn = winners.filter(w => w.prize === prize.name).length + 1;

            // Thêm người trúng giải vào danh sách
            const winnerData = {
                date: new Date().toISOString().slice(0, 16),
                prize: prize.name,
                turn: currentTurn,
                name: winner.name,
                department: winner.department,
                code: randomCode
            };
            winners.push(winnerData);
            localStorage.setItem('winners', JSON.stringify(winners));

            // Hiển thị kết quả
            const resultSection = document.getElementById('resultSection');
            document.getElementById('resultPrize').textContent = prize.name;
            document.getElementById('resultTurn').textContent = currentTurn;
            document.getElementById('resultName').textContent = winner.name;
            document.getElementById('resultDepartment').textContent = winner.department;
            document.getElementById('resultCode').textContent = randomCode;
            resultSection.style.display = 'block';

            // Xóa nút quay số nếu đã quay đủ số lần
            if (currentTurn >= prize.turns) {
                const button = buttonGroup.querySelector(`button:nth-child(${prizeIndex + 1})`);
                if (button) button.remove();
            }

            // Ẩn nút "Quay" sau khi quay xong
            document.querySelector('.go').style.display = 'none';
            currentPrize = null;
            currentPrizeIndex = -1;
        }

        // jQuery code
        $(document).ready(function () {
            // Khởi tạo slots 
            createSlots($('#ring1'));
            createSlots($('#ring2'));
            createSlots($('#ring3'));
            createSlots($('#ring4'));
            createSlots($('#ring5'));
            createSlots($('#ring6'));

            // Hook start button
            $('.go').on('click', function () {
                var timer = 2;
                spin(timer);
            });

            // Hook xray checkbox
            $('#xray').on('click', function () {
                var tilt = 'tiltout';

                if ($(this).is(':checked')) {
                    tilt = 'tiltin';
                    $('.slot').addClass('backface-on');
                    $('#rotate').css('animation', tilt + ' 2s 1');

                    setTimeout(function () {
                        $('#rotate').toggleClass('tilted');
                    }, 2000);
                } else {
                    tilt = 'tiltout';
                    $('#rotate').css({ 'animation': tilt + ' 2s 1' });

                    setTimeout(function () {
                        $('#rotate').toggleClass('tilted');
                        $('.slot').removeClass('backface-on');
                    }, 1900);
                }
            });

            // Hook perspective
            $('#perspective').on('click', function () {
                $('#stage').toggleClass('perspective-on perspective-off');
            });
        });
    </script>
</body>
</html>